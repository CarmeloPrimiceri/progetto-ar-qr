<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esperienza AR con Marker Pattern - Mondo degli Spiritelli</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>

    <!-- AR.js - Versione stabile con supporto per marker pattern -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <!-- Mixer per animazioni GLTF -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<!-- Overlay iniziale per avviare l'esperienza e l'audio -->
<div id="start-overlay" class="start-overlay">
    <div class="start-container">
        <h2>Il Mondo degli Spiritelli</h2>
        <p>Un'avventura in RealtÃ  Aumentata</p>
        <button id="startExperience" class="start-btn">Inizia Esperienza</button>
    </div>
</div>

<!-- Schermata di caricamento -->
<div class="loading-screen">
    <div class="spinner"></div>
    <div class="loading-text">Caricamento dell'esperienza AR...</div>
</div>

<!-- Istruzioni -->
<div class="instructions">
    Punta la fotocamera verso i marker per iniziare l'avventura nel mondo degli spiritelli!
</div>

<!-- Container per il dialogo -->
<div class="dialog-container">
    <div class="dialog-text"></div>
    <div class="choices-container"></div>
</div>

<!-- Controlli audio -->
<div class="audio-controls">
    <button id="toggleAudio" class="audio-btn">
        <span id="audioIcon">ðŸ”Š</span>
    </button>
</div>

<!-- Scena AR - Configurazione per marker pattern -->
<a-scene
        embedded
        arjs="sourceType: webcam; debugUIEnabled: true; trackingMethod: best;"
        renderer="antialias: true; alpha: true;"
        vr-mode-ui="enabled: false"
        loading-screen="enabled: false">

    <a-assets>
        <!-- Modelli 3D per i diversi spiritelli -->
        <a-asset-item id="spiritello-model" src="assets/models/Fiorellino.glb"></a-asset-item>

        <!-- Audio di sottofondo -->
        <audio id="background-music" src="assets/audio/background-music.mp3" preload="auto" loop></audio>
    </a-assets>

    <!-- EntitÃ  audio che riproduce la musica di sottofondo -->
    <a-entity sound="src: #background-music; autoplay: true; loop: true; volume: 0.5"></a-entity>

    <!-- Utilizziamo marker pattern predefiniti che funzionano sicuramente -->
    <!-- Brochure - Marker Hiro -->
    <a-marker id="brochure" preset="hiro" raycaster="objects: .clickable" emitevents="true" cursor="fuse: false; rayOrigin: mouse;">
        <!-- Il modello 3D verrÃ  inserito dinamicamente tramite JavaScript -->
    </a-marker>

    <!-- I marker pattern sono piÃ¹ affidabili e possono essere creati in seguito per ogni spiritello -->
    <!-- Esempio di come definire un marker pattern personalizzato: -->
    <!--
    <a-marker id="blu" type="pattern" url="assets/patterns/pattern-blu.patt" raycaster="objects: .clickable" emitevents="true" cursor="fuse: false; rayOrigin: mouse;">
    </a-marker>
    -->

    <!-- Camera -->
    <a-entity camera></a-entity>
</a-scene>

<!-- Debug info -->
<div id="debug-info" style="position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; font-family: monospace; z-index: 9999; max-width: 50%;">
    Debug: Nessun marker rilevato
</div>

<!-- Pulsante per il reset della fotocamera -->
<button id="resetCamera" style="position: fixed; top: 80px; right: 20px; padding: 8px; background-color: rgba(0,0,0,0.7); color: white; border: none; border-radius: 5px; z-index: 9999;">
    ðŸ”„ Reset Camera
</button>

<!-- Script per gestire lo zoom e il debug -->
<script>
    // Funzione per resettare lo zoom della fotocamera
    function resetCameraSettings() {
        const videoEl = document.querySelector('video');
        if (videoEl && videoEl.srcObject) {
            const stream = videoEl.srcObject;
            const tracks = stream.getVideoTracks();

            tracks.forEach(track => {
                if (track.getCapabilities && track.getCapabilities().zoom) {
                    track.applyConstraints({
                        advanced: [{zoom: 1}] // Reset zoom a 1x
                    }).catch(e => console.error('Errore nel reset dello zoom:', e));
                }
            });

            console.log('Reset zoom della fotocamera completato');
        }
    }

    // Script per inizializzare l'applicazione
    document.addEventListener('DOMContentLoaded', function() {
        const debugInfo = document.getElementById('debug-info');
        const markers = document.querySelectorAll('a-marker');
        const resetButton = document.getElementById('resetCamera');

        // Aggiungi event listener per il pulsante di reset
        if (resetButton) {
            resetButton.addEventListener('click', resetCameraSettings);
        }

        // Aggiungi event listener per i marker
        markers.forEach(marker => {
            marker.addEventListener('markerFound', () => {
                debugInfo.textContent = `Debug: Marker "${marker.id}" trovato!`;
                debugInfo.style.backgroundColor = 'rgba(0,255,0,0.7)';
                setTimeout(() => {
                    debugInfo.style.backgroundColor = 'rgba(0,0,0,0.7)';
                }, 2000);
            });

            marker.addEventListener('markerLost', () => {
                debugInfo.textContent = 'Debug: Marker perso';
            });
        });

        // Reset zoom iniziale e quando l'utente torna alla pagina
        setTimeout(resetCameraSettings, 2000);
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                setTimeout(resetCameraSettings, 1000);
            }
        });

        // Gestione pulsante audio
        const toggleAudioBtn = document.getElementById('toggleAudio');
        const audioIcon = document.getElementById('audioIcon');
        let isAudioPlaying = true;

        if (toggleAudioBtn && audioIcon) {
            toggleAudioBtn.addEventListener('click', function() {
                const audioEntity = document.querySelector('a-entity[sound]');
                if (audioEntity) {
                    if (isAudioPlaying) {
                        // Disattiva l'audio
                        audioEntity.setAttribute('sound', 'volume', 0);
                        audioIcon.textContent = 'ðŸ”‡';
                    } else {
                        // Attiva l'audio
                        audioEntity.setAttribute('sound', 'volume', 0.5);
                        audioIcon.textContent = 'ðŸ”Š';
                    }
                    isAudioPlaying = !isAudioPlaying;
                }
            });
        }

        // Gestione overlay iniziale
        const startOverlay = document.getElementById('start-overlay');
        const startButton = document.getElementById('startExperience');

        if (startButton && startOverlay) {
            startButton.addEventListener('click', function() {
                startOverlay.style.display = 'none';

                // Avvia l'audio
                const audioEntity = document.querySelector('a-entity[sound]');
                if (audioEntity) {
                    audioEntity.setAttribute('sound', 'volume', 0.5);
                }
            });
        }
    });
</script>

<!-- JavaScript originali dell'applicazione -->
<script src="js/dialog.js"></script>
<script src="js/main.js"></script>
</body>
</html>